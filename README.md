# üöÄ Docker Swarm - Stack de Automa√ß√£o Completa

Esta √© uma solu√ß√£o completa para deploy automatizado de uma stack de automa√ß√£o de workflows usando **Docker Swarm**, incluindo **PostgreSQL**, **Redis**, **n8n** e **Portainer**.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Componentes](#componentes)
- [Pr√©-requisitos](#pr√©-requisitos)
- [Instala√ß√£o R√°pida](#instala√ß√£o-r√°pida)
- [Instala√ß√£o Manual](#instala√ß√£o-manual)
- [Configura√ß√µes](#configura√ß√µes)
- [URLs de Acesso](#urls-de-acesso)
- [Gerenciamento](#gerenciamento)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Troubleshooting](#troubleshooting)
- [Contribui√ß√£o](#contribui√ß√£o)

## üéØ Vis√£o Geral

Este projeto oferece uma instala√ß√£o automatizada e completa de uma infraestrutura de automa√ß√£o de workflows baseada em Docker Swarm, incluindo todas as depend√™ncias necess√°rias para um ambiente de produ√ß√£o robusto.

### ‚ú® Caracter√≠sticas Principais

- üîß **Instala√ß√£o 100% automatizada** com um √∫nico comando
- üê≥ **Docker Swarm** para alta disponibilidade e escalabilidade
- üìä **PostgreSQL 16** como banco de dados principal
- ‚ö° **Redis 7** para cache e gerenciamento de filas
- üîÑ **n8n** em modo regular ou distribu√≠do (queue)
- üéõÔ∏è **Portainer** para gest√£o visual dos containers
- üîí **Configura√ß√µes de seguran√ßa** autom√°ticas
- üìù **Logs detalhados** durante toda a instala√ß√£o

## üß© Componentes

| Componente | Vers√£o | Fun√ß√£o | Porto |
|------------|--------|--------|-------|
| **PostgreSQL** | 16 | Banco de dados principal | 5432 (interno) |
| **Redis** | 7 | Cache e gerenciamento de filas | 6379 (interno) |
| **RedisInsight** | Latest | Interface web para Redis | 5540 |
| **n8n** | 1.100.1+ | Plataforma de automa√ß√£o | Conforme dom√≠nio |
| **Portainer** | Latest | Gest√£o de containers | Conforme configura√ß√£o |

## ‚öôÔ∏è Pr√©-requisitos

### Sistema Operacional
- **Debian/Ubuntu** (testado em Debian 11/12 e Ubuntu 20.04/22.04)
- **Acesso root** ou usu√°rio com sudo

### Hardware M√≠nimo
- **CPU**: 2 cores
- **RAM**: 4GB
- **Disco**: 20GB livres
- **Rede**: Conectividade com a internet

### Dom√≠nios
- Um dom√≠nio principal (ex: `exemplo.com`)
- Acesso aos subdom√≠nios:
  - `fluxos.exemplo.com` (Editor n8n)
  - `webhook.exemplo.com` (Webhooks n8n)

## üöÄ Instala√ß√£o R√°pida

### 1. Clone o reposit√≥rio
```bash
git clone <repository-url>
cd install
```

### 2. Execute a instala√ß√£o automatizada
```bash
sudo ./install.sh
```

### 3. Processo de Instala√ß√£o Interativa

O script ir√° executar as seguintes etapas automaticamente:

#### üìã **Etapa 1: Verifica√ß√µes Iniciais**
- Verifica se est√° rodando como root/sudo
- Confirma que √© um sistema Debian/Ubuntu
- Exibe banner de in√≠cio

#### üè∑Ô∏è **Etapa 2: Configura√ß√£o do Hostname**
```
Digite o hostname desejado para esta m√°quina (ex: manager1): mgt01
```
- Define hostname do servidor
- Atualiza `/etc/hosts`
- Configura identifica√ß√£o no cluster

#### üê≥ **Etapa 3: Instala√ß√£o do Docker**
```
=== INSTALANDO DOCKER ===
Atualizando sistema e instalando depend√™ncias...
Adicionando chave GPG do Docker...
Instalando Docker...
Docker instalado com sucesso!
```
- Instala depend√™ncias do sistema
- Adiciona reposit√≥rio oficial do Docker
- Instala Docker CE, CLI e plugins
- Habilita servi√ßos para inicializa√ß√£o autom√°tica

#### üîó **Etapa 4: Configura√ß√£o do Docker Swarm**
```
Escolha uma op√ß√£o:
1) Inicializar um novo Swarm (Manager)
2) Juntar-se a um Swarm existente (Worker)
Digite sua escolha (1 ou 2): 1

Digite o IP deste servidor para anunciar o Swarm: 192.168.1.100
```
- **Op√ß√£o 1**: Inicializa novo cluster (primeiro servidor)
- **Op√ß√£o 2**: Conecta a cluster existente (servidores adicionais)
- Cria redes overlay necess√°rias automaticamente

#### üõ†Ô∏è **Etapa 5: Ferramentas Opcionais**
```
Deseja instalar ctop (monitor de containers)? (y/N): y
Instalando ctop...
ctop instalado com sucesso!
```
- Oferece instala√ß√£o do ctop para monitoramento

#### üì¶ **Etapa 6: Cria√ß√£o de Volumes**
```
=== CRIANDO VOLUMES DOCKER ===
Criando volume postgres_data...
Criando volume redis_data...
Criando volume redis_insigth_data...
```
- Cria volumes persistentes para bancos de dados

#### üóÑÔ∏è **Etapa 7: Deploy do PostgreSQL**
```
Deseja fazer deploy do PostgreSQL? (Y/n): y
Digite a senha para o PostgreSQL (deixe vazio para usar padr√£o): [ENTER]
Fazendo deploy do PostgreSQL...
PostgreSQL deployado com sucesso!
```
- Deploy do PostgreSQL 16
- Configura√ß√£o autom√°tica de senha
- Aguarda disponibilidade do servi√ßo

#### ‚ö° **Etapa 8: Deploy do Redis**
```
Deseja fazer deploy do Redis? (Y/n): y
Fazendo deploy do Redis...
Redis deployado com sucesso!

Deseja instalar RedisInsight (interface web)? (y/N): y
RedisInsight deployado com sucesso!
```
- Deploy do Redis 7 para cache e filas
- Op√ß√£o de instalar interface web (porta 5540)

#### üéõÔ∏è **Etapa 9: Deploy do Portainer (Opcional)**
```
Deseja fazer deploy do Portainer? (y/N): y
Fazendo pull da imagem do Portainer...
Fazendo deploy do Portainer...
Portainer deployado com sucesso!
```
- Interface web para gerenciar Docker Swarm

#### üîÑ **Etapa 10: Configura√ß√£o do n8n**
```
=== CONFIGURANDO VARI√ÅVEIS DE AMBIENTE DO N8N ===
Digite o dom√≠nio principal (ex: exemplo.com): meusite.com
Subdom√≠nios configurados:
  - Workflow Editor: fluxos
  - Webhooks: webhook

Digite o nome do banco de dados PostgreSQL: n8n_production
Digite a senha do banco de dados PostgreSQL: [senha oculta]
Digite a chave de criptografia N8N (deixe vazio para gerar automaticamente): [ENTER]
Chave de criptografia gerada automaticamente

Deseja configurar SMTP personalizado? (y/N): y
=== CONFIGURANDO SMTP ===
Host SMTP: smtp.gmail.com
Porta SMTP: 587
Usu√°rio SMTP: seuemail@gmail.com
Senha SMTP: [senha oculta]
Email do remetente: seuemail@gmail.com
```
- Coleta dom√≠nio principal
- **Subdom√≠nios fixos**: fluxos.meusite.com e webhook.meusite.com
- Configura√ß√£o do banco de dados
- Gera√ß√£o autom√°tica de chave de criptografia
- Configura√ß√£o SMTP opcional

#### üöÄ **Etapa 11: Deploy do n8n**
```
Escolha o modo de deploy do n8n:
1) Modo Regular (single instance)
2) Modo Queue (editor + webhook + worker)
3) Pular deploy do n8n
Digite sua escolha (1, 2 ou 3): 2

Fazendo deploy do n8n (modo queue)...
Deployando editor...
Deployando webhook...
Deployando worker...
n8n (modo queue) deployado com sucesso!
```
- **Modo Regular**: Uma inst√¢ncia √∫nica
- **Modo Queue**: Distribu√≠do para alta performance
- Deploy autom√°tico com vari√°veis configuradas

#### ‚úÖ **Etapa 12: Status Final**
```
=== STATUS FINAL ===
=== CONFIGURA√á√ïES DAS APLICA√á√ïES ===
PostgreSQL instalado:
  - Host: postgres (interno do Swarm)
  - Porta: 5432
  - Usu√°rio: postgres
  - Senha: (salva no .env)

Redis instalado:
  - Host: redis (interno do Swarm)
  - Porta: 6379
  - RedisInsight: porta 5540

n8n instalado:
  - Editor URL: https://fluxos.meusite.com/
  - Webhook URL: https://webhook.meusite.com/
  - Banco de Dados: n8n_production

Arquivo .env criado com as vari√°veis de ambiente
IMPORTANTE: Guarde o arquivo .env em local seguro!
```

### 4. Tempo de Instala√ß√£o
- **Tempo total**: 10-15 minutos
- **Maior parte**: Download de imagens Docker
- **Intera√ß√£o**: 2-3 minutos de prompts

## üîß Instala√ß√£o Manual

Se preferir controlar cada etapa individualmente:

### 1. Configura√ß√£o b√°sica
```bash
# Configurar hostname
sudo bash infra/1.setup-base.sh

# Instalar Docker
sudo bash infra/2.setup-docker.sh

# Configurar Docker Swarm
sudo bash infra/3.setup-swarm.sh

# Instalar ferramentas opcionais
sudo bash infra/4.setup-optional.sh
```

### 2. Criar volumes
```bash
docker volume create postgres_data
docker volume create redis_data
docker volume create redis_insigth_data
```

### 3. Deploy das aplica√ß√µes
```bash
# PostgreSQL
docker stack deploy -c postgres16/postgres.yaml postgres

# Redis
docker stack deploy -c redis/redis.yaml redis
docker stack deploy -c redis/redisInsight.yaml redisinsight  # Opcional

# Portainer
docker stack deploy -c portainer/portainer.yaml portainer

# n8n (modo queue)
export DOMAIN="seu-dominio.com"
export DATABASE="n8n_db"
export DATABASE_PASSWORD="sua_senha"

docker stack deploy -c n8n/queue/orq_editor.yaml n8n_editor
docker stack deploy -c n8n/queue/orq_webhook.yaml n8n_webhook
docker stack deploy -c n8n/queue/orq_worker.yaml n8n_worker
```

## ‚öôÔ∏è Configura√ß√µes

### Vari√°veis de Ambiente

O script cria automaticamente um arquivo `.env` com todas as configura√ß√µes:

```bash
# Configura√ß√µes de Dom√≠nio
DOMAIN=exemplo.com
WORKFLOW=fluxos
WEBHOOK=webhook

# Configura√ß√µes de Banco de Dados
DATABASE=n8n_production
DATABASE_PASSWORD=senha_super_segura

# Configura√ß√µes de Seguran√ßa
N8N_ENCRYPTION_KEY=chave_criptografia_32_chars

# Configura√ß√µes PostgreSQL
POSTGRES_PASSWORD=senha_postgres

# Configura√ß√µes SMTP (opcional)
N8N_SMTP_HOST=smtp.gmail.com
N8N_SMTP_PORT=587
N8N_SMTP_USER=seuemail@gmail.com
N8N_SMTP_PASS=sua_senha_app
N8N_SMTP_SENDER=seuemail@gmail.com
```

### Modos de Deploy do n8n

#### Modo Regular (Single Instance)
- Uma √∫nica inst√¢ncia do n8n
- Ideal para cargas de trabalho pequenas/m√©dias
- Mais simples de gerenciar

#### Modo Queue (Distribu√≠do)
- **Editor**: Interface principal
- **Webhook**: Recebe webhooks externos
- **Worker**: Executa workflows em background
- Ideal para alta disponibilidade e cargas pesadas

## üåê URLs de Acesso

Ap√≥s a instala√ß√£o completa, voc√™ ter√° acesso √†s seguintes URLs:

| Servi√ßo | URL | Fun√ß√£o |
|---------|-----|--------|
| **n8n Editor** | `https://fluxos.SEU_DOMINIO.com` | Interface principal do n8n |
| **n8n Webhooks** | `https://webhook.SEU_DOMINIO.com` | Endpoint para webhooks |
| **RedisInsight** | `http://SEU_SERVIDOR:5540` | Interface do Redis |
| **Portainer** | Conforme configura√ß√£o YAML | Gest√£o de containers |

## üõ†Ô∏è Gerenciamento

### Comandos √öteis

```bash
# Ver status dos stacks
docker stack ls

# Ver servi√ßos de um stack
docker stack services n8n_editor

# Ver logs de um servi√ßo
docker service logs n8n_editor_n8n_editor_ip2

# Atualizar um servi√ßo
docker service update n8n_editor_n8n_editor_ip2

# Remover um stack
docker stack rm n8n_editor

# Monitorar containers (se ctop instalado)
docker-ctop

# Carregar vari√°veis de ambiente
source .env
```

### Backup e Restore

#### PostgreSQL
```bash
# Backup
docker exec $(docker ps -q -f name=postgres) pg_dumpall -U postgres > backup.sql

# Restore
cat backup.sql | docker exec -i $(docker ps -q -f name=postgres) psql -U postgres
```

#### Redis
```bash
# Backup
docker exec $(docker ps -q -f name=redis) redis-cli SAVE
docker cp $(docker ps -q -f name=redis):/data/dump.rdb ./redis-backup.rdb

# Restore
docker cp ./redis-backup.rdb $(docker ps -q -f name=redis):/data/dump.rdb
docker restart $(docker ps -q -f name=redis)
```

## üìÅ Estrutura do Projeto

```
install/
‚îú‚îÄ‚îÄ üìÑ install.sh              # Script principal de instala√ß√£o
‚îú‚îÄ‚îÄ üìÑ README.md              # Este arquivo
‚îú‚îÄ‚îÄ üìÑ CLAUDE.md              # Documenta√ß√£o para Claude Code
‚îú‚îÄ‚îÄ üìÑ .env                   # Vari√°veis de ambiente (criado na instala√ß√£o)
‚îÇ
‚îú‚îÄ‚îÄ üìÅ infra/                 # Scripts de infraestrutura
‚îÇ   ‚îú‚îÄ‚îÄ 1.setup-base.sh      # Configura√ß√£o de hostname
‚îÇ   ‚îú‚îÄ‚îÄ 2.setup-docker.sh    # Instala√ß√£o do Docker
‚îÇ   ‚îú‚îÄ‚îÄ 3.setup-swarm.sh     # Configura√ß√£o do Swarm
‚îÇ   ‚îú‚îÄ‚îÄ 4.setup-optional.sh  # Ferramentas opcionais
‚îÇ   ‚îî‚îÄ‚îÄ 5.setup-ssh.md       # Documenta√ß√£o SSH
‚îÇ
‚îú‚îÄ‚îÄ üìÅ postgres16/           # PostgreSQL
‚îÇ   ‚îî‚îÄ‚îÄ postgres.yaml        # Configura√ß√£o do PostgreSQL
‚îÇ
‚îú‚îÄ‚îÄ üìÅ redis/                # Redis
‚îÇ   ‚îú‚îÄ‚îÄ redis.yaml           # Configura√ß√£o do Redis
‚îÇ   ‚îî‚îÄ‚îÄ redisInsight.yaml    # Interface web do Redis
‚îÇ
‚îú‚îÄ‚îÄ üìÅ portainer/            # Portainer
‚îÇ   ‚îî‚îÄ‚îÄ portainer.yaml       # Configura√ß√£o do Portainer
‚îÇ
‚îî‚îÄ‚îÄ üìÅ n8n/                  # n8n
    ‚îú‚îÄ‚îÄ üìÅ regular/           # Modo single instance
    ‚îÇ   ‚îî‚îÄ‚îÄ n8n-regular.yaml
    ‚îî‚îÄ‚îÄ üìÅ queue/             # Modo distribu√≠do
        ‚îú‚îÄ‚îÄ orq_editor.yaml   # Editor
        ‚îú‚îÄ‚îÄ orq_webhook.yaml  # Webhook handler
        ‚îî‚îÄ‚îÄ orq_worker.yaml   # Worker
```

## üêõ Troubleshooting

### Problemas Comuns

#### Docker n√£o inicia
```bash
sudo systemctl status docker
sudo systemctl restart docker
```

#### Swarm n√£o inicializa
```bash
# Verificar se j√° existe um Swarm
docker info | grep Swarm

# For√ßar nova inicializa√ß√£o
docker swarm leave --force
docker swarm init --advertise-addr=SEU_IP
```

#### Servi√ßos n√£o sobem
```bash
# Verificar logs
docker service logs NOME_DO_SERVICO

# Verificar recursos
docker node ls
docker system df
```

#### n8n n√£o conecta com PostgreSQL
```bash
# Verificar se PostgreSQL est√° rodando
docker service ls | grep postgres

# Verificar logs do PostgreSQL
docker service logs postgres_postgres

# Verificar conectividade de rede
docker network ls | grep database
```

### Logs e Monitoramento

```bash
# Logs do script de instala√ß√£o
tail -f /var/log/install.log

# Status dos servi√ßos
docker service ls

# Uso de recursos
docker stats

# Monitoramento cont√≠nuo (se ctop instalado)
docker-ctop
```

## üîí Seguran√ßa

### Boas Pr√°ticas Implementadas

- ‚úÖ **Senhas geradas automaticamente** para todos os servi√ßos
- ‚úÖ **Redes isoladas** para bancos de dados
- ‚úÖ **Criptografia de dados** do n8n
- ‚úÖ **Usu√°rios n√£o-root** nos containers
- ‚úÖ **Limites de recursos** para todos os servi√ßos

### Recomenda√ß√µes Adicionais

- üîê Altere as senhas padr√£o ap√≥s a instala√ß√£o
- üî• Configure firewall adequadamente
- üîÑ Implemente backups regulares
- üìä Configure monitoramento de logs
- üîí Use certificados SSL v√°lidos

## ü§ù Contribui√ß√£o

Contribui√ß√µes s√£o bem-vindas! Para contribuir:

1. Fa√ßa um fork do projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

## üìû Suporte

Para suporte e d√∫vidas:

- üìß Abra uma issue no reposit√≥rio
- üìñ Consulte a documenta√ß√£o em `CLAUDE.md`
- üîç Verifique os logs de instala√ß√£o

## üìù Licen√ßa

Este projeto est√° sob a licen√ßa [MIT](LICENSE) - veja o arquivo LICENSE para detalhes.

---

**‚ö° Feito com ‚ù§Ô∏è para automa√ß√£o de workflows**

> üí° **Dica**: Guarde o arquivo `.env` em local seguro - ele cont√©m todas as credenciais do seu ambiente!